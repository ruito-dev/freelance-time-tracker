openapi: 3.0.3
info:
  title: Freelance Time Tracker API
  description: |
    フリーランス向けタスク管理 & 時間トラッキングアプリケーションのREST API仕様書
    
    ## 認証
    JWT (JSON Web Token) ベースの認証を使用します。
    ログイン後に取得したトークンを`Authorization: Bearer {token}`ヘッダーに含めてリクエストしてください。
    
    ## 特徴
    - RESTful設計
    - JSON形式のレスポンス
    - 日本語エラーメッセージ
    - ページネーション対応
  version: 1.0.0
  contact:
    name: API Support
    email: ruito.dev@gmail.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api/v1
    description: 開発環境
  - url: https://api.example.com/api/v1
    description: 本番環境(予定)

tags:
  - name: Authentication
    description: 認証関連のエンドポイント
  - name: Projects
    description: プロジェクト管理
  - name: Tasks
    description: タスク管理
  - name: TimeEntries
    description: 時間記録管理
  - name: Reports
    description: レポート取得

paths:
  /auth/signup:
    post:
      tags:
        - Authentication
      summary: ユーザー登録
      description: 新規ユーザーを登録し、JWTトークンを発行します
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
              properties:
                user:
                  type: object
                  required:
                    - name
                    - email
                    - password
                    - password_confirmation
                  properties:
                    name:
                      type: string
                      example: 山田太郎
                    email:
                      type: string
                      format: email
                      example: yamada@example.com
                    password:
                      type: string
                      format: password
                      minLength: 6
                      example: password123
                    password_confirmation:
                      type: string
                      format: password
                      example: password123
      responses:
        '201':
          description: ユーザー登録成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '422':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: ログイン
      description: メールアドレスとパスワードでログインし、JWTトークンを発行します
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: yamada@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: ログイン成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: メールアドレスまたはパスワードが正しくありません

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: トークンリフレッシュ
      description: 現在のトークンを使用して新しいトークンを発行します
      operationId: refreshToken
      security:
        - bearerAuth: []
      responses:
        '200':
          description: トークンリフレッシュ成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: 現在のユーザー情報取得
      description: 認証されたユーザーの情報を取得します
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ユーザー情報取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /projects:
    get:
      tags:
        - Projects
      summary: プロジェクト一覧取得
      description: 認証されたユーザーのプロジェクト一覧を取得します
      operationId: listProjects
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: プロジェクト一覧取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  projects:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProjectSummary'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - Projects
      summary: プロジェクト作成
      description: 新しいプロジェクトを作成します
      operationId: createProject
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project
              properties:
                project:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                      example: Webサイトリニューアル
                    description:
                      type: string
                      example: コーポレートサイトの全面リニューアル
      responses:
        '201':
          description: プロジェクト作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectSummary'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '422':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /projects/{id}:
    get:
      tags:
        - Projects
      summary: プロジェクト詳細取得
      description: 指定されたプロジェクトの詳細情報を取得します
      operationId: getProject
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: プロジェクト詳細取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDetail'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    put:
      tags:
        - Projects
      summary: プロジェクト更新
      description: 指定されたプロジェクトを更新します
      operationId: updateProject
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project
              properties:
                project:
                  type: object
                  properties:
                    name:
                      type: string
                    description:
                      type: string
      responses:
        '200':
          description: プロジェクト更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectSummary'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'

    delete:
      tags:
        - Projects
      summary: プロジェクト削除
      description: 指定されたプロジェクトを削除します(関連するタスクと時間記録も削除されます)
      operationId: deleteProject
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: プロジェクト削除成功
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /projects/{project_id}/tasks:
    get:
      tags:
        - Tasks
      summary: タスク一覧取得
      description: 指定されたプロジェクトのタスク一覧を取得します
      operationId: listTasks
      security:
        - bearerAuth: []
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: integer
          description: プロジェクトID
        - name: status
          in: query
          schema:
            type: string
            enum: [todo, in_progress, done]
          description: ステータスフィルター
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: タスク一覧取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskSummary'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    post:
      tags:
        - Tasks
      summary: タスク作成
      description: 指定されたプロジェクトに新しいタスクを作成します
      operationId: createTask
      security:
        - bearerAuth: []
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: integer
          description: プロジェクトID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - task
              properties:
                task:
                  type: object
                  required:
                    - title
                  properties:
                    title:
                      type: string
                      example: デザイン作成
                    description:
                      type: string
                      example: トップページのデザイン
                    status:
                      type: string
                      enum: [todo, in_progress, done]
                      default: todo
      responses:
        '201':
          description: タスク作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSummary'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'

  /tasks/{id}:
    get:
      tags:
        - Tasks
      summary: タスク詳細取得
      description: 指定されたタスクの詳細情報を取得します
      operationId: getTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: タスク詳細取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskDetail'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    put:
      tags:
        - Tasks
      summary: タスク更新
      description: 指定されたタスクを更新します
      operationId: updateTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - task
              properties:
                task:
                  type: object
                  properties:
                    title:
                      type: string
                    description:
                      type: string
                    status:
                      type: string
                      enum: [todo, in_progress, done]
      responses:
        '200':
          description: タスク更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSummary'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'

    delete:
      tags:
        - Tasks
      summary: タスク削除
      description: 指定されたタスクを削除します(関連する時間記録も削除されます)
      operationId: deleteTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: タスク削除成功
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /tasks/{task_id}/time_entries:
    get:
      tags:
        - TimeEntries
      summary: 時間記録一覧取得
      description: 指定されたタスクの時間記録一覧を取得します
      operationId: listTimeEntries
      security:
        - bearerAuth: []
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: integer
          description: タスクID
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: 時間記録一覧取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  time_entries:
                    type: array
                    items:
                      $ref: '#/components/schemas/TimeEntry'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    post:
      tags:
        - TimeEntries
      summary: 時間記録開始
      description: 指定されたタスクの時間記録を開始します
      operationId: createTimeEntry
      security:
        - bearerAuth: []
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: integer
          description: タスクID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - time_entry
              properties:
                time_entry:
                  type: object
                  required:
                    - started_at
                  properties:
                    started_at:
                      type: string
                      format: date-time
                      example: '2026-01-20T13:00:00.000Z'
      responses:
        '201':
          description: 時間記録開始成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'

  /time_entries/{id}/stop:
    put:
      tags:
        - TimeEntries
      summary: 時間記録停止
      description: 指定された時間記録を停止し、作業時間を自動計算します
      operationId: stopTimeEntry
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ended_at
              properties:
                ended_at:
                  type: string
                  format: date-time
                  example: '2026-01-20T15:30:00.000Z'
      responses:
        '200':
          description: 時間記録停止成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'

  /time_entries/{id}:
    delete:
      tags:
        - TimeEntries
      summary: 時間記録削除
      description: 指定された時間記録を削除します
      operationId: deleteTimeEntry
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: 時間記録削除成功
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /reports/summary:
    get:
      tags:
        - Reports
      summary: サマリーレポート取得
      description: プロジェクトとタスクのサマリーレポートを取得します
      operationId: getSummaryReport
      security:
        - bearerAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          description: 開始日(YYYY-MM-DD)
          example: '2026-01-01'
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          description: 終了日(YYYY-MM-DD)
          example: '2026-01-31'
        - name: project_id
          in: query
          schema:
            type: integer
          description: プロジェクトIDでフィルター
      responses:
        '200':
          description: レポート取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryReport'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWTトークンを使用した認証

  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: リソースID

    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: ページ番号

    PerPageParam:
      name: per_page
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: 1ページあたりの件数

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: 山田太郎
        email:
          type: string
          format: email
          example: yamada@example.com
        created_at:
          type: string
          format: date-time
          example: '2026-01-20T12:00:00.000Z'

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        user:
          $ref: '#/components/schemas/User'

    ProjectSummary:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Webサイトリニューアル
        description:
          type: string
          nullable: true
          example: コーポレートサイトの全面リニューアル
        tasks_count:
          type: integer
          example: 15
        total_duration:
          type: integer
          description: 合計作業時間(秒)
          example: 86400
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProjectDetail:
      allOf:
        - $ref: '#/components/schemas/ProjectSummary'
        - type: object
          properties:
            tasks:
              type: array
              items:
                $ref: '#/components/schemas/TaskSummary'

    TaskSummary:
      type: object
      properties:
        id:
          type: integer
          example: 1
        title:
          type: string
          example: デザイン作成
        description:
          type: string
          nullable: true
          example: トップページのデザイン
        status:
          type: string
          enum: [todo, in_progress, done]
          example: done
        project_id:
          type: integer
          example: 1
        time_entries_count:
          type: integer
          example: 5
        total_duration:
          type: integer
          description: 合計作業時間(秒)
          example: 14400
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TaskDetail:
      allOf:
        - $ref: '#/components/schemas/TaskSummary'
        - type: object
          properties:
            project_name:
              type: string
              example: Webサイトリニューアル
            time_entries:
              type: array
              items:
                $ref: '#/components/schemas/TimeEntry'

    TimeEntry:
      type: object
      properties:
        id:
          type: integer
          example: 1
        started_at:
          type: string
          format: date-time
          example: '2026-01-15T10:00:00.000Z'
        ended_at:
          type: string
          format: date-time
          nullable: true
          example: '2026-01-15T13:00:00.000Z'
        duration:
          type: integer
          nullable: true
          description: 作業時間(秒)。ended_atがnullの場合はnull
          example: 10800
        task_id:
          type: integer
          example: 1
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SummaryReport:
      type: object
      properties:
        summary:
          type: object
          properties:
            total_projects:
              type: integer
              example: 5
            total_tasks:
              type: integer
              example: 45
            total_duration:
              type: integer
              description: 合計作業時間(秒)
              example: 432000
            total_duration_hours:
              type: number
              format: float
              description: 合計作業時間(時間)
              example: 120.0
            tasks_by_status:
              type: object
              properties:
                todo:
                  type: integer
                  example: 15
                in_progress:
                  type: integer
                  example: 10
                done:
                  type: integer
                  example: 20
        projects:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
              total_duration:
                type: integer
              total_duration_hours:
                type: number
                format: float
              tasks_count:
                type: integer
              completed_tasks_count:
                type: integer
        daily_breakdown:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              total_duration:
                type: integer
              total_duration_hours:
                type: number
                format: float
              tasks_worked:
                type: integer

    PaginationMeta:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        total_pages:
          type: integer
          example: 3
        total_count:
          type: integer
          example: 45

    Error:
      type: object
      properties:
        error:
          type: string
          example: エラーメッセージ

    ValidationError:
      type: object
      properties:
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            name: ['を入力してください']
            email: ['は不正な値です', 'はすでに存在します']

  responses:
    UnauthorizedError:
      description: 認証エラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: 認証が必要です

    NotFoundError:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: リソースが見つかりません

    ValidationError:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
